{"componentChunkName":"component---src-templates-blog-post-js","path":"/lowcostcluster/","result":{"data":{"site":{"siteMetadata":{"title":"The Matrix"}},"markdownRemark":{"id":"5afa6629-48c5-51ae-ac79-b3fcf347de8b","excerpt":"Create a Low Cost GKE Cluster This document describes how to create a minimal-cost GKE cluster and deploy to it using GitHub Actions. Create a Low Cost Cluster…","html":"<h1>Create a Low Cost GKE Cluster</h1>\n<h3>This document describes how to create a minimal-cost GKE cluster and deploy to it using GitHub Actions.</h3>\n<hr>\n<h2>Create a Low Cost Cluster</h2>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">gcloud container clusters create <span class=\"token string\">\"medium-cost-cluster\"</span> <span class=\"token punctuation\">\\</span>\n    <span class=\"token parameter variable\">--zone</span> <span class=\"token string\">\"us-central1-a\"</span> <span class=\"token punctuation\">\\</span>\n    --num-nodes<span class=\"token operator\">=</span><span class=\"token number\">1</span> <span class=\"token punctuation\">\\</span>\n    --machine-type <span class=\"token string\">\"e2-medium\"</span> <span class=\"token punctuation\">\\</span>\n    <span class=\"token parameter variable\">--spot</span> <span class=\"token punctuation\">\\</span>\n    --disk-type <span class=\"token string\">\"pd-standard\"</span> <span class=\"token punctuation\">\\</span>\n    --disk-size <span class=\"token string\">\"30GB\"</span> <span class=\"token punctuation\">\\</span>\n    --release-channel <span class=\"token string\">\"stable\"</span></code></pre></div>\n<h2>Create a New Artifact Registry Repository</h2>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">gcloud artifacts repositories create my-simple-repo <span class=\"token punctuation\">\\</span>\n    --repository-format<span class=\"token operator\">=</span>docker <span class=\"token punctuation\">\\</span>\n    <span class=\"token parameter variable\">--location</span><span class=\"token operator\">=</span>us-central1</code></pre></div>\n<h2>Create a Workload Identity Pool</h2>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">gcloud iam workload-identity-pools create <span class=\"token string\">\"github-pool\"</span> <span class=\"token parameter variable\">--location</span><span class=\"token operator\">=</span><span class=\"token string\">\"global\"</span></code></pre></div>\n<h3>Create a Workload Identity Provider</h3>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">gcloud iam workload-identity-pools providers create-oidc <span class=\"token string\">\"my-repo-provider\"</span> <span class=\"token punctuation\">\\</span>\n    <span class=\"token parameter variable\">--location</span><span class=\"token operator\">=</span><span class=\"token string\">\"global\"</span> <span class=\"token punctuation\">\\</span>\n    --workload-identity-pool<span class=\"token operator\">=</span><span class=\"token string\">\"github-pool\"</span> <span class=\"token punctuation\">\\</span>\n    --issuer-uri<span class=\"token operator\">=</span><span class=\"token string\">\"https://token.actions.githubusercontent.com\"</span> <span class=\"token punctuation\">\\</span>\n    --attribute-mapping<span class=\"token operator\">=</span><span class=\"token string\">\"google.subject=assertion.sub,attribute.repository=assertion.repository,attribute.repository_owner=assertion.repository_owner\"</span> <span class=\"token punctuation\">\\</span>\n    --attribute-condition<span class=\"token operator\">=</span><span class=\"token string\">\"attribute.repository_owner == 'alancj731'\"</span></code></pre></div>\n<h2>Create a Service Account</h2>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">gcloud iam service-accounts create <span class=\"token string\">\"github-actions-sa\"</span> <span class=\"token punctuation\">\\</span>\n    --display-name<span class=\"token operator\">=</span><span class=\"token string\">\"GitHub Actions Service Account\"</span></code></pre></div>\n<br>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">gcloud iam workload-identity-pools list <span class=\"token punctuation\">\\</span>\n    <span class=\"token parameter variable\">--project</span><span class=\"token operator\">=</span><span class=\"token string\">\"plasma-set-485717-s0\"</span> <span class=\"token punctuation\">\\</span>\n    <span class=\"token parameter variable\">--location</span><span class=\"token operator\">=</span><span class=\"token string\">\"global\"</span></code></pre></div>\n<h2>GitHub Actions Secrets and Variables</h2>\n<h4>Set the following values in:</h4>\n<h5><strong>Repository → Settings → Secrets and variables → Actions</strong></h5>\n<h4>GCP_PROJECT_ID:</h4>\n<p>use this commmand to show your project id and number</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">gcloud projects list</code></pre></div>\n<h4>GCP_SA_EMAIL:</h4>\n<h6>Format:</h6>\n<p><strong>{SERVICE_ACCOUNT_NAME}@{PROJECT_ID}.iam.gserviceaccount.com</strong></p>\n<h4>GCP_WORKLOAD_IDENTITY_PROVIDER:</h4>\n<h6>Format:</h6>\n<p><strong>projects/{PROJECT_NUMBER}/locations/global/workloadIdentityPools/{POOL_ID}/providers/{PROVIDER_ID}</strong></p>\n<h6>You can also use this command to show your providers</h6>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">gcloud iam workload-identity-pools providers list <span class=\"token punctuation\">\\</span>\n    <span class=\"token parameter variable\">--location</span><span class=\"token operator\">=</span><span class=\"token string\">\"global\"</span> <span class=\"token punctuation\">\\</span>\n    --workload-identity-pool<span class=\"token operator\">=</span><span class=\"token string\">\"YOUR_POOL_ID\"</span> <span class=\"token punctuation\">\\</span>\n    <span class=\"token parameter variable\">--format</span><span class=\"token operator\">=</span><span class=\"token string\">\"value(name)\"</span></code></pre></div>\n<h2>GitHub Actions Workflow</h2>\n<p><strong>File:</strong>.github/workflows/deployment.yaml</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Deploy to GKE\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">push</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">branches</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>main<span class=\"token punctuation\">]</span>\n\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">deploy</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\n    <span class=\"token key atrule\">permissions</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">contents</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"read\"</span>\n      <span class=\"token key atrule\">id-token</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"write\"</span>\n\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Checkout code\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@v4\n\n      <span class=\"token comment\"># 1. Authenticate to Google Cloud</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">id</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"auth\"</span>\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"google-github-actions/auth@v2\"</span>\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">workload_identity_provider</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}\"</span>\n          <span class=\"token key atrule\">service_account</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"${{ secrets.GCP_SA_EMAIL }}\"</span>\n\n      <span class=\"token comment\"># 2. Get GKE Credentials</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Set up GKE credentials\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"google-github-actions/get-gke-credentials@v2\"</span>\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">cluster_name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"medium-cost-cluster\"</span>\n          <span class=\"token key atrule\">location</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"us-central1-a\"</span>\n\n      <span class=\"token comment\"># 3. Build and Push Image (Using Artifact Registry)</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Build and Push Docker Image\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n          gcloud auth configure-docker us-central1-docker.pkg.dev\n          docker build -t us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/my-simple-repo/my-app:${{ github.sha }} .\n          docker push us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/my-simple-repo/my-app:${{ github.sha }}</span>\n\n      <span class=\"token comment\"># 4. Deploy to Cluster</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Deploy to GKE\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n          # This replaces the 'IMAGE_PLACEHOLDER' in your deployment.yaml with the real image path\n          sed -i \"s|IMAGE_PLACEHOLDER|us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/my-simple-repo/my-app:${{ github.sha }}|g\" k8s/deployment.yaml\n          kubectl apply -f k8s/</span></code></pre></div>\n<h2>Kubernetes Deployment</h2>\n<p><strong>File:</strong> k8s/deployment.yaml</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apps/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Deployment\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> my<span class=\"token punctuation\">-</span>web<span class=\"token punctuation\">-</span>app<span class=\"token punctuation\">-</span>service\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> hello<span class=\"token punctuation\">-</span>world\n  <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> hello<span class=\"token punctuation\">-</span>world\n    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> web<span class=\"token punctuation\">-</span>container\n        <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> IMAGE_PLACEHOLDER  <span class=\"token comment\"># The CI/CD script will replace this</span>\n        <span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">requests</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">cpu</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"10m\"</span>      <span class=\"token comment\"># Minimal reservation to fit on cheap nodes</span>\n            <span class=\"token key atrule\">memory</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"32Mi\"</span>\n          <span class=\"token key atrule\">limits</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">cpu</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"500m\"</span>     <span class=\"token comment\"># High limit so it doesn't get slow</span>\n            <span class=\"token key atrule\">memory</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"256Mi\"</span> <span class=\"token comment\"># High limit so it doesn't crash</span>\n<span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Service\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> my<span class=\"token punctuation\">-</span>web<span class=\"token punctuation\">-</span>app<span class=\"token punctuation\">-</span>service\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> hello<span class=\"token punctuation\">-</span>world\n  <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">protocol</span><span class=\"token punctuation\">:</span> TCP\n      <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n      <span class=\"token key atrule\">targetPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n</code></pre></div>\n<h2>Kubernetes Service (LoadBalancer)</h2>\n<p><strong>File:</strong> k8s/service.yaml</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Service\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> my<span class=\"token punctuation\">-</span>web<span class=\"token punctuation\">-</span>app<span class=\"token punctuation\">-</span>service\n  <span class=\"token key atrule\">annotations</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># This line tells GKE to look for a Standard Tier IP</span>\n    <span class=\"token key atrule\">cloud.google.com/network-tier</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Standard\"</span>\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> LoadBalancer\n  <span class=\"token key atrule\">loadBalancerIP</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"35.208.88.209\"</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> hello<span class=\"token punctuation\">-</span>world\n  <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">protocol</span><span class=\"token punctuation\">:</span> TCP\n      <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n      <span class=\"token key atrule\">targetPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span></code></pre></div>\n<h2>Kubernetes Ingress</h2>\n<p><strong>File:</strong> k8s/ingress.yaml</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> networking.k8s.io/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Ingress\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> my<span class=\"token punctuation\">-</span>web<span class=\"token punctuation\">-</span>app<span class=\"token punctuation\">-</span>ingress\n  <span class=\"token key atrule\">annotations</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># Use the NAME of your GLOBAL static IP</span>\n    <span class=\"token key atrule\">kubernetes.io/ingress.global-static-ip-name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"my-cheap-ip\"</span>\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">rules</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">paths</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> /\n        <span class=\"token key atrule\">pathType</span><span class=\"token punctuation\">:</span> Prefix\n        <span class=\"token key atrule\">backend</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">service</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> my<span class=\"token punctuation\">-</span>web<span class=\"token punctuation\">-</span>app<span class=\"token punctuation\">-</span>service\n            <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">number</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span></code></pre></div>","frontmatter":{"title":"Create a Low Cost Cluster","date":"January 29, 2026","description":"Deploy a cluster with one medium size node"}},"previous":{"fields":{"slug":"/usestaticip/"},"frontmatter":{"title":"Get a Persistent IP for GCP Spot instances"}},"next":null},"pageContext":{"id":"5afa6629-48c5-51ae-ac79-b3fcf347de8b","previousPostId":"74626bd8-bd2d-570f-a8c6-ad7abf0f5b1f","nextPostId":null}},"staticQueryHashes":["2841359383","4135132960"],"slicesMap":{}}